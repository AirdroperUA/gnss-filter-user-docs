# Інструкція з тюнінгу під час роботи

Фільтр публікує вибрані константи як MAVLink `PARAM_*`, тому поведінку можна змінювати без оновлення прошивки.

## Доступні параметри тюнінгу

| Param | Значення | Default | Min | Max |
|---|---|---:|---:|---:|
| `RJ_BASE_M` | Базові бокові обмеження повторного приєднання (м) | 120 | 10 | 10000 |
| `RJ_SPD_MULT` | Множник швидкості у формулі воріт | 8 | 0 | 100 |
| `RJ_EXP_RMPS` | Швидкість розширення воріт у DR1 (м/с) | 8 | 0 | 200 |
| `RJ_EXP_MAXM` | Максимальне розширення воріт (м) | 200000 | 100 | 1000000 |
| `RJ_DOP2M` | Масштаб HDOP у метри | 20 | 0 | 200 |
| `RJ_HDOP_MUL` | Множник HDOP | 2 | 0 | 20 |
| `RJ_MIN_SATS` | Мін. кількість супутників для повторного приєднання | 8 | 4 | 30 |
| `RJ_MAX_HD` | Макс. HDOP для повторного приєднання | 2.5 | 0.5 | 10 |
| `RJ_LOIT_V` | Поріг малої швидкості для loiter (м/с) | 0.8 | 0 | 10 |
| `RJ_LOIT_MS` | Час loiter перед розширенням воріт (мс) | 8000 | 500 | 120000 |
| `RJ_LOIT_GM` | Loiter-обмеження (м) | 2500 | 10 | 1000000 |
| `RJ_STAB_MS` | Вікно стабільності перед повторним приєднанням/blend (мс) | 5000 | 500 | 120000 |
| `BLEND_MS` | Тривалість blend DR1 → DR0 (мс) | 10000 | 1000 | 120000 |
| `DR_LOCK_MS` | Мін. блокувальне вікно DR1 (мс) | 120000 | 0 | 600000 |
| `SP_JMP_MPS` | Ліміт стрибка швидкості (м/с) | 5000 | 50 | 20000 |
| `SP_ABS_M` | Ліміт абсолютного стрибка позиції (м) | 5000 | 100 | 50000 |
| `ARM_MIN_S` | Мін. супутників для активації захистів | 6 | 4 | 30 |
| `ARM_MAX_HD` | Макс. HDOP для активації захистів | 4 | 0.5 | 10 |
| `ARM_STABMS` | Вікно стабільності для активації (мс) | 2000 | 200 | 10000 |
| `ALT_BSATS` | Мін. супутників для калібрування alt-bias | 8 | 4 | 30 |
| `ALT_BHDOP` | Макс. HDOP для калібрування alt-bias | 2.5 | 0.5 | 10 |
| `ALT_CALM_V` | Макс. вертикальна швидкість для «спокійного» вікна (м/с) | 2 | 0.1 | 20 |
| `ALT_BCMS` | Тривалість «спокійного» вікна (мс) | 2000 | 200 | 30000 |
| `ALT_JMP_M` | Абсолютний стрибок висоти (м) | 80 | 5 | 500 |
| `ALT_RMPS` | Поріг швидкості зміни висоти (м/с) | 40 | 1 | 200 |
| `ALT_RDTMS` | Мін. dt для висотного rate-захисту (мс) | 600 | 100 | 5000 |
| `ALT_RDH_M` | Мін. дельта-H для rate-захисту (м) | 20 | 1 | 200 |
| `ALT_BSEP_M` | Розходження GNSS проти баро (м) | 100 | 10 | 500 |
| `ALT_BSEPMS` | Час утримання розходження (мс) | 1500 | 100 | 20000 |
| `ALT_RJSEP` | Макс. розходження висоти для повторного приєднання (м) | 50 | 5 | 500 |
| `DR_NOFIX` | Показувати NO_FIX у DR/blend (0/1) | 1 | 0 | 1 |
| `RJ_REQEKF` | Вимагати EKF OK для повторного приєднання (0/1) | 0 | 0 | 1 |
| `NUDGE_EN` | Увімкнути DR1 nudge до GNSS (0/1) | 1 | 0 | 1 |
| `NUDGE_MPS` | Швидкість nudge (м/с) | 8 | 0 | 50 |
| `NUDGE_FRAC` | Макс. частка nudge за крок | 0.5 | 0 | 1 |
| `EKF_TRIPMS` | Час поганого EKF для DR1 (мс) | 1500 | 200 | 10000 |
| `EKF_OKRJMS` | Час доброго EKF для повторного приєднання (мс) | 3000 | 200 | 20000 |
| `EKF_GRCMS` | EKF-grace після виходу DR0 (мс) | 7000 | 0 | 60000 |
| `BOOT_NSATS` | Мін. супутників для boot north gate | 6 | 4 | 30 |
| `BOOT_NHDOP` | Макс. HDOP для boot north gate | 4 | 0.5 | 10 |
| `BOOT_NSTAB` | Вікно стабільності boot north gate (мс) | 1000 | 200 | 20000 |
| `BOOT_DLYMS` | Додаткова затримка DR‑тригерів після старту (мс) | 10000 | 0 | 120000 |
| `GN_HOTMS` | Тригер hotstart watchdog (мс) | 15000 | 1000 | 120000 |
| `GN_COLDMS` | Тригер coldstart watchdog (мс) | 45000 | 2000 | 300000 |
| `PT_ONLY` | Лише режим pass-through (0/1) | 1 | 0 | 1 |
| `FCGPS_FWD` | Примусове пересилання на FC GPS навіть у DR1 (0/1) | 0 | 0 | 1 |
| `NMEA_NOFIX` | Виводити NMEA no-fix маяки (0/1) | 0 | 0 | 1 |
| `LOG_MS` | Період логів статусу (мс) | 15000 | 1000 | 120000 |
| `NAV_AGEMS` | Макс. вік NAV для валідного GPS (мс) | 5000 | 200 | 60000 |
| `NAV_STALLMS` | Поріг попередження про stall NAV (мс) | 7000 | 500 | 120000 |
| `GNSS_SWAP` | Обмін RX/TX GNSS UART (0/1) | 0 | 0 | 1 |
| `SNR_EN` | Увімкнути SNR‑захист (0/1) | 0 | 0 | 1 |
| `SNR_MSATS` | Мін. супутників для SNR‑захисту | 8 | 4 | 30 |
| `SNR_DMAX` | Макс. допустимий розкид SNR (max-min, dB-Hz) | 6 | 1 | 40 |
| `SNR_MMAX` | Мін. значення найсильнішого SNR (dB-Hz) | 35 | 10 | 60 |
| `SNR_HOLDMS` | Час утримання SNR‑захисту до DR1 (мс) | 1500 | 100 | 20000 |
| `SNR_MAXAGE` | Макс. давність SNR-вибірки (мс) | 2000 | 100 | 10000 |

## Детальний опис параметрів

### Обмеження повторного приєднання (rejoin) та таймінги

- **RJ_BASE_M**: Базові бокові обмеження для повторного приєднання (rejoin). Це стартова допустима відстань між синтетичною позицією та реальним GNSS. Збільшуйте для довгих DR1; зменшуйте, щоб не приймати великі зміщення.
- **RJ_SPD_MULT**: Множник швидкості, який додається до воріт. Збільшує допуск на високих швидкостях. Надто великий — допускає великі стрибки, надто малий — заважає повторному приєднанню на швидкості.
- **RJ_EXP_RMPS**: Швидкість розширення воріт у DR1 (м/с). Дозволяє обмеженням збільшуватися з часом. Високі значення прискорюють повторне приєднання після довгих DR1, але знижують захист.
- **RJ_EXP_MAXM**: Максимальний ліміт розширення. **Не обмежує дальність польоту**, лише обмежує розмір воріт. Якщо замалий — повторне приєднання може не відбутися; якщо завеликий — приймаються дуже великі відхилення.
- **RJ_DOP2M**: Перевід HDOP у метри для воріт. Вищі значення дають більші обмеження при поганій геометрії.
- **RJ_HDOP_MUL**: Додатковий множник для HDOP‑терму. Дозволяє швидко змінювати вплив DOP.
- **RJ_MIN_SATS**: Мінімум супутників для повторного приєднання. Вищі значення — якісніше повторне приєднання, нижчі — швидше.
- **RJ_MAX_HD**: Максимальний HDOP для повторного приєднання. Нижче — суворіше.
- **RJ_LOIT_V**: Поріг малої швидкості для loiter‑умови.
- **RJ_LOIT_MS**: Час перебування нижче порогу, після якого застосовується loiter‑обмеження.
- **RJ_LOIT_GM**: Loiter‑обмеження (перевизначення розміру воріт після таймера).
- **RJ_STAB_MS**: Вікно стабільності перед стартом повторного приєднання/blend. Довше — безпечніше, але повільніше.
- **BLEND_MS**: Тривалість blend DR1→DR0. Довше — м’якший перехід.
- **DR_LOCK_MS**: Мінімальне блокувальне вікно після входу в DR1. Під час блокування повторне приєднання заборонено.

### Захист від спуфінгу (стрибки позиції)

- **SP_JMP_MPS**: Ліміт швидкості між фіксами. Перевищення → DR1 (після армінгу).
- **SP_ABS_M**: Абсолютний ліміт стрибка позиції за один фікс. Ловить телепорти.

### Активація захистів (коли вмикаються перевірки)

- **ARM_MIN_S**: Мінімум супутників для активації.
- **ARM_MAX_HD**: Максимальний HDOP для активації.
- **ARM_STABMS**: Час стабільності для активації.

### Висотні захисти

- **ALT_BSATS**: Мін. супутників для калібрування alt‑bias.
- **ALT_BHDOP**: Макс. HDOP для калібрування alt‑bias.
- **ALT_CALM_V**: Макс. вертикальна швидкість у «спокійному» вікні.
- **ALT_BCMS**: Тривалість «спокійного» вікна.
- **ALT_JMP_M**: Абсолютний стрибок висоти для DR1.
- **ALT_RMPS**: Поріг швидкості зміни висоти.
- **ALT_RDTMS**: Мін. час для rate‑перевірки.
- **ALT_RDH_M**: Мін. зміна висоти для rate‑перевірки.
- **ALT_BSEP_M**: Допустиме розходження GNSS проти баро.
- **ALT_BSEPMS**: Час утримання розходження.
- **ALT_RJSEP**: Макс. розходження висоти для повторного приєднання.

### Поведінка DR

- **DR_NOFIX**: Показує NO_FIX у DR1/blend, щоб FC не використовував GNSS.
- **PT_ONLY**: Лише режим pass‑through без синтетики/blend.
- **FCGPS_FWD**: Примусово пересилає GNSS навіть у DR1. Використовуйте тільки для діагностики.
- **NMEA_NOFIX**: Додаткові NMEA no‑fix повідомлення (опційно).

### EKF‑умови

- **RJ_REQEKF**: Вимагає EKF OK перед повторним приєднанням.
- **EKF_TRIPMS**: Час поганого EKF для DR1.
- **EKF_OKRJMS**: Час доброго EKF для повторного приєднання (якщо ввімкнено `RJ_REQEKF`).
- **EKF_GRCMS**: Grace‑період після виходу з DR1.

### Boot north gate

- **BOOT_NSATS**: Мін. супутників для старту публікації GNSS.
- **BOOT_NHDOP**: Макс. HDOP для старту.
- **BOOT_NSTAB**: Вікно стабільності для старту.
- **BOOT_DLYMS**: Додаткова стартова затримка перед тим, як спуф/ЕКФ‑тригери зможуть перевести фільтр у DR1. Збільшуйте, якщо після вмикання живлення виникає хибний DR1 до стабілізації FC та GNSS.

### Watchdog відновлення GNSS

- **GN_HOTMS**: Час з нульовими супутниками до hotstart.
- **GN_COLDMS**: Час з нульовими супутниками до coldstart.

### Обробка GNSS та логи

- **LOG_MS**: Період статус‑логів.
- **NAV_AGEMS**: Макс. вік NAV для валідного GNSS.
- **NAV_STALLMS**: Поріг stall‑попередження.
- **GNSS_SWAP**: Обмін RX/TX GNSS UART під час роботи.

### SNR‑захист (близький глушник/спуфер)

- **SNR_EN**: Увімкнення SNR‑захисту.
- **SNR_MSATS**: Мін. супутників для оцінки.
- **SNR_DMAX**: Макс. допустимий розкид SNR (max‑min).
- **SNR_MMAX**: Мін. значення найсильнішого SNR.
- **SNR_HOLDMS**: Час утримання умови до DR1.
- **SNR_MAXAGE**: Макс. давність вибірки SNR.

## Збереження

- Зміни застосовуються одразу.
- Фільтр автоматично зберігає у NVM приблизно через 1,5 с після останньої зміни.

## Використання `tools/tune_cli.py`

Встановіть залежність:

```bash
python -m pip install pymavlink
```

Список поточних значень:

```bash
python tools/tune_cli.py --port COM12 --baud 115200 list
```

Читання одного значення:

```bash
python tools/tune_cli.py --port COM12 --baud 115200 get BLEND_MS
```

Запис одного значення:

```bash
python tools/tune_cli.py --port COM12 --baud 115200 set RJ_BASE_M 180
```

Експорт профілю:

```bash
python tools/tune_cli.py --port COM12 --baud 115200 export tune_baseline.json
```

Імпорт профілю:

```bash
python tools/tune_cli.py --port COM12 --baud 115200 import tune_baseline.json
```

Строгий імпорт (помилка на невідомих ключах):

```bash
python tools/tune_cli.py --port COM12 --baud 115200 import tune_baseline.json --strict
```

## Mission Planner (тільки читання параметрів фільтра)

Mission Planner використовуйте для параметрів STM32-фільтра лише в режимі читання.

- Виберіть **STM32-фільтр (SYSID 42)** у списку систем.
- Використовуйте лише **Read/Refresh** для перегляду значень.
- **Не** використовуйте Mission Planner **Write** для параметрів STM32-фільтра.
- Змінюйте параметри фільтра тільки через `tools/tune_cli.py`.

## Практичний робочий процес

1. Експортуйте базовий JSON.
2. Змінюйте 1–2 параметри за раз.
3. Льотні тести та логи.
4. Зберігайте перевірені JSON-профілі для швидкого відкату.

Примітки:

- `GNSS_SWAP` застосовується одразу і запускає переналаштування GNSS.
- Якщо після `GNSS_SWAP` GNSS зник, поверніть значення назад.

## Приклади тригерів

Ці приклади передбачають, що захисти вже активовані (`ARM_MIN_S`, `ARM_MAX_HD`, `ARM_STABMS`).

### Тригер розкиду SNR (SNR‑захист)

Налаштування:

- `SNR_EN=1`
- `SNR_MSATS=8`
- `SNR_DMAX=6`
- `SNR_MMAX=35`
- `SNR_HOLDMS=1500`
- `SNR_MAXAGE=2000`

Викликає DR1:

- 12 супутників, C/N0 у діапазоні `36..40` dB-Hz понад 1,5 с.
- `max=40`, `min=36`, `span=4` (<= 6), і найсильніший сигнал >= 35.

Не викликає DR1:

- Той самий вузький розкид, але `max=30` (< `SNR_MMAX`), або вибірка застаріла (`age > SNR_MAXAGE`), або супутників менше `SNR_MSATS`.

### Тригер стрибка позиції

Налаштування:

- `SP_ABS_M=5000`
- `SP_JMP_MPS=5000`

Викликає DR1:

- Один фікс стрибнув ~12 км за ~1 с (`12000 м` > обох лімітів).

Не викликає DR1:

- 50 м за 1 с.

### Тригер абсолютного стрибка висоти

Налаштування:

- `ALT_JMP_M=80`

Викликає DR1:

- Висота GNSS змінилась з `120 м` до `230 м` за одне оновлення (`+110 м`).

Не викликає DR1:

- Нормальні зміни в межах порогу.

### Тригер швидкості висоти

Налаштування:

- `ALT_RMPS=40`
- `ALT_RDTMS=600`
- `ALT_RDH_M=20`

Викликає DR1:

- ~30 м за 600 мс (`50 м/с` і ΔH >= 20 м).

Не викликає DR1:

- 10 м за 1 с (`10 м/с`) або короткі/шумні зміни нижче `ALT_RDH_M`.

### Тригер розходження висоти і баро

Налаштування:

- `ALT_BSEP_M=100`
- `ALT_BSEPMS=1500`

Викликає DR1:

- Стійке розходження GNSS проти баро > 100 м понад 1,5 с.

Не викликає DR1:

- Короткі піки, що зникають до завершення таймера.

### Тригер EKF

Налаштування:

- `EKF_TRIPMS=1500`

Викликає DR1:

- EKF повідомляє поганий стан горизонталі (або glitch/accel error) безперервно > 1,5 с.

Не викликає DR1:

- Короткі збої EKF менші за `EKF_TRIPMS`.

## Приклади повторного приєднання (rejoin)

### Швидке повторне приєднання (м’якші налаштування)

- `RJ_MIN_SATS=8`
- `RJ_MAX_HD=2.5`
- `RJ_STAB_MS=5000`
- `RJ_REQEKF=0`

Повторне приєднання починається після стабільних перевірок `RJ_STAB_MS`, далі запускається blend `BLEND_MS`.

### Консервативне повторне приєднання

- `RJ_REQEKF=1`
- `EKF_OKRJMS=5000`
- `DR_LOCK_MS=120000`

Навіть при доброму GNSS повернення в DR0 чекає на вікно EKF OK і завершення блокування.
