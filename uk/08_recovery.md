# Інструкція відновлення (одна сторінка)

Використовуйте це, коли оновлення/завантаження не вдалося і плата не запускає застосунок.

## Симптоми

- Немає нормальних heartbeat/статусних повідомлень моста.
- Пристрій живиться, але «завис».
- Після Phase-B прошивки застосунок не стартує.

## Швидка діагностика

1. Перевірте проводку і живлення (5V, GND, USB-кабель).
2. Відкрийте STM32CubeProgrammer і перевірте, що MCU визначився.
3. Прочитайте перші байти flash за адресами:
   - `0x08000000` (вектори bootloader)
   - `0x08007C00` (metadata)
   - `0x08008000` (вектори app)

Якщо metadata/app порожні або пошкоджені — перепрошийте повний Phase-B набір.

## Повний порядок відновлення (рекомендується)

1. Прошити bootloader:
   - бінарник: `firmware.bin` з `blackpill_f401cc_phaseb_bootloader`
   - адреса: `0x08000000`
2. Прошити app:
   - бінарник: `firmware.bin` з `blackpill_f401cc_phaseb_app`
   - адреса: `0x08008000`
3. Прошити підписану metadata:
   - бінарник: `boot_meta.bin`
   - адреса: `0x08007C00`
4. Перезапустити плату і підтвердити старт застосунку.

## Приклади CubeProgrammer CLI (Windows)

```powershell
STM32_Programmer_CLI.exe -c port=USB1 -w bootloader.bin 0x08000000 -v
STM32_Programmer_CLI.exe -c port=USB1 -w app.bin        0x08008000 -v
STM32_Programmer_CLI.exe -c port=USB1 -w boot_meta.bin  0x08007C00 -v -rst
```

## Якщо anti-rollback відхиляє образ

- Bootloader порівнює `app_version` з metadata з `BOOTLOADER_MIN_APP_VERSION`.
- Якщо образ старіший за поріг, він не стартує.

Варіанти:

1. Прошити новіший підписаний app/metadata з версією >= порогу.
2. Перезібрати/перепрошити bootloader з нижчим порогом (лише якщо потрібен rollback).

## Безпечний fallback

Якщо Phase-B відновлення заблоковане в полі, прошийте стабільний Phase-A app у `0x08000000`
(`blackpill_f401cc` середовище), щоб швидко відновити роботу, і вже потім поверніться до Phase-B.

## Профілактичні перевірки перед кожним релізом

- Перевірте, що публічний ключ у bootloader відповідає приватному ключу підпису.
- Переконайтесь, що `boot_meta.bin` згенеровано з точного app-бінарника.
- Зберігайте архів одного відомо-робочого набору артефактів:
  - `bootloader.bin`, `app.bin`, `boot_meta.bin`, `release.json`.

