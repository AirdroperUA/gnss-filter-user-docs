# Огляд пристрою

Цей документ описує, як STM32‑фільтр працює між GNSS‑приймачем і польотним контролером (FC).

## Терміни (короткий словник)

- **DR (dead-reckoning)**: оцінка позиції з IMU/airspeed, коли GNSS ненадійний. Працює недовго і поступово накопичує похибку.
- **DR0**: нормальний режим. GNSS передається на GPS UART FC.
- **DR1**: захисний режим. Пересилання GNSS блокується, FC покладається лише на інерціальні оцінки.
- **FC**: польотний контролер (ArduPilot).
- **GNSS**: супутниковий навігаційний приймач (u-blox).
- **GPS**: система супутникового позиціонування. У цьому документі «GPS» означає вхід GNSS і GPS UART на FC.
- **UART**: простий послідовний інтерфейс (TX/RX) для підключення модулів.
- **MAVLink**: протокол телеметрії/керування між STM32 і FC.
- **MAV**: скорочення для MAVLink (телеметрія/керування).
- **GCS**: наземна станція керування (Mission Planner, QGroundControl).
- **UBX**: бінарний протокол GNSS u-blox.
- **EKF**: розширений фільтр Калмана у FC.

## Сумісність і безпека

- Потрібен **ArduPilot 4.6.1 або новіший**.
- Вхід GNSS має бути **UBX (u-blox)**. Інші протоколи не підтримуються.
- Перші польоти виконуйте на недорогій платформі, яку легко відновити (наприклад, 10-дюймовий FPV-квадрокоптер з ArduPilot або невелике крило на кшталт Reptile Dragon V2). Перевірте поведінку перед встановленням на дорогий БПЛА.

## 1) Призначення

Фільтр працює між GNSS і FC та виконує три основні задачі:

1. **Парсить UBX від GNSS** і оцінює якість сигналу та аномалії.
2. **Керує станом DR (DR0/DR1)**, дозволяючи або блокуючи передавання GNSS на GPS UART FC.
3. **Подає GNSS на FC лише у DR0**, блокуючи його в DR1.

## 2) Шляхи даних

Є три UART-з’єднання:

- GNSS і STM32: вхід UBX для контролю якості.
- FC MAVLink і STM32: статус, команди та тюнінг.
- FC GPS і STM32: «сире» UBX‑передавання на GPS UART FC.

У DR0 GNSS дані передаються на GPS UART FC.

У DR1 пересилання GNSS блокується, щоб не передавати підозрілі дані до FC.

## 3) DR0 та DR1

### DR0 (нормальний режим)

- GNSS передається на GPS UART FC.
- Захисні перевірки DR відстежують якість GNSS.

### DR1 (захисний режим)

- Пересилання UBX на GPS UART FC вимкнене.
- `B5` переводиться у високий рівень (~3 секунди) при вході.

## 4) Що може ввімкнути DR1 (приклади)

### Приклад A: стрибок позиції

- Різкий стрибок на сотні або тисячі кілометрів.
- Захист перевищує `SP_ABS_M` або `SP_JMP_MPS`.
- Вхід у DR1.

### Приклад B: аномалія SNR (близький глушник/спуфер)

- Кількість супутників висока, але розкид SNR аномально вузький.
- Розкид зберігається довше `SNR_HOLDMS`.
- За умови `SNR_EN=1` вхід у DR1.

### Приклад C: аномалія висоти

- Великий разовий стрибок висоти або надмірна швидкість зміни.
- Велике розходження GNSS проти баро, яке тримається.
- Висотні захисти переводять у DR1.

## 5) Повернення з DR1 (rejoin)

Фільтр повертається в DR0 тільки після:

- мінімальної якості GNSS (`RJ_MIN_SATS`, `RJ_MAX_HD`),
- виконання стабільного вікна (`RJ_STAB_MS`),
- завершення вікна блокування (`DR_LOCK_MS`),
- додаткових умов EKF (якщо ввімкнені).

Якщо умови виконані, за потреби запускається плавний перехід (blend, `BLEND_MS`), після чого відновлюється DR0.

## 6) Приклад сценарію

1. Політ нормальний: DR0.
2. Починається підміна або завади.
3. Фільтр переходить у DR1 і блокує GNSS.
4. Сигнал повертається до нормального.
5. Після стабільних перевірок фільтр повертається у DR0.

## 7) Що можна тюнити «на льоту»

Через `tools/tune_cli.py` можна змінювати пороги без перепрошивки:

- пороги/таймінги повторного приєднання (`RJ_*`, `BLEND_MS`, `DR_LOCK_MS`),
- антиспуфінг та висотні захисти (`SP_*`, `ALT_*`),
- SNR‑захист (`SNR_*`),
- поведінка DR (`DR_NOFIX`, `RJ_REQEKF`, тощо).

Це дозволяє адаптувати поведінку для різних умов і профілів польоту.

## 8) Ключові робочі примітки

- Карта GCS може показувати GNSS‑стрибки під час спуфінгу. Основне джерело істини — DR‑стан і логи фільтра.
- Консервативне повторне приєднання (rejoin) безпечніше за швидке у складних умовах GNSS.
- Зберігайте базовий профіль параметрів перед польовими змінами.
